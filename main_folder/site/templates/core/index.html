<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestatEval - Цифровая платформа для анализа рынка недвижимости</title>
    
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .hero-section {
            background-image: url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1673&q=80');
            background-size: cover;
            background-position: center;
            height: 500px;
        }
        
        .benefits-card {
            background-color: #222;
            color: #fff;
            transition: transform 0.3s ease;
        }
        
        .benefits-card:hover {
            transform: translateY(-5px);
        }
        
        .map-container {
            height: 400px;
            width: 100%;
        }
        
        .results-section {
            background-color: #f9f9f9;
        }
        
        .scenario-card {
            border: 1px solid #ddd;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .active-tab {
            border-bottom: 2px solid #38b2ac;
            color: #38b2ac;
        }
        
        .strategy-card {
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .strategy-card.selected {
            border-color: #38b2ac;
            background-color: rgba(56, 178, 172, 0.1);
        }
        
        .strategy-card:hover {
            border-color: #38b2ac;
        }
    </style>
</head>
<body class="bg-white">
    

<header class="header fixed w-full top-0 z-50 py-4 px-6 flex justify-between items-center border-b border-gray-200">
    <div class="logo text-2xl font-bold">RestatEval</div>
    <div class="flex items-center space-x-4">
      
            
            <a href="#" class="text-gray-600 hover:text-gray-900 py-2 px-4">Мой профиль</a>
            <a href="/logout/" class="text-gray-600 hover:text-gray-900 py-2 px-4">Выйти</a>
       
            
            <a href="/auth/login/yandex-oauth2/" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Войти через Яндекс</a>
            <a href="/auth/login/google-oauth2/" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">Войти через Google</a>
     
        <a href="#" class="text-gray-600 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        </a>
    </div>
</header>


    
    <section class="hero-section flex items-center justify-center mt-16">
        <div class="text-center text-white">
            <h1 class="text-5xl font-bold mb-4">RestatEval</h1>
            <p class="text-xl mb-8">Цифровой взгляд на рынок новостроек</p>
        </div>
    </section>

    
    <section class="py-16 px-6">
        <h2 class="text-3xl font-bold text-center mb-12">Наши преимущества</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <div class="benefits-card p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Точность прогнозов</h3>
                <p>Наши алгоритмы используют передовые технологии машинного обучения для создания точных прогнозов стоимости объектов недвижимости с учетом множества факторов.</p>
            </div>
            
            <div class="benefits-card p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Сценарии доходности</h3>
                <p>Анализируйте различные инвестиционные сценарии, сравнивайте стратегии использования недвижимости и выбирайте оптимальные решения для максимальной доходности ваших вложений.</p>
            </div>
            
            <div class="benefits-card p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Подробный анализ</h3>
                <p>Получайте детальную информацию о факторах, влияющих на стоимость объекта, включая инфраструктуру и другие параметры локации для принятия обоснованных решений.</p>
            </div>
        </div>
    </section>

    
    <section class="py-16 px-6 bg-gray-100">
        <h2 class="text-3xl font-bold text-center mb-8">Калькулятор стоимости</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
            <div>
                <p class="mb-4 text-center">Нажмите на карту, чтобы выбрать локацию</p>
                <div id="map" class="map-container rounded-lg shadow-lg"></div>
                <input type="hidden" id="location_lat" name="location_lat">
                <input type="hidden" id="location_lng" name="location_lng">
                <input type="hidden" id="location_address" name="location_address">
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4">Настройте параметры для получения прогноза</h3>
                
                <form id="prediction-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Средняя площадь квартиры</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="area" name="area" min="20" max="200" value="60" class="w-full">
                            <span id="area-value" class="text-sm font-medium">60 м²</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Тип помещения</label>
                        <select id="property_type" name="property_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="studio">Студия</option>
                            <option value="1-room">1-комнатная</option>
                            <option value="2-room" selected>2-комнатная</option>
                            <option value="3-room">3-комнатная</option>
                            <option value="4-room">4+ комнатная</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Год постройки</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="build_year" name="build_year" min="2025" max="2050" value="2030" class="w-full">
                            <span id="build_year-value" class="text-sm font-medium">2030</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Отделка</label>
                        <select id="finishing_type" name="finishing_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="no">Без отделки</option>
                            <option value="rough">Черновая</option>
                            <option value="fine" selected>Чистовая</option>
                            <option value="furniture">С мебелью</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Этаж</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="floor" name="floor" min="1" max="50" value="10" class="w-full">
                            <span id="floor-value" class="text-sm font-medium">10</span>
                        </div>
                    </div>
                    
                    <button type="submit" id="calculate-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                        Рассчитать прогноз
                    </button>
                </form>
            </div>
        </div>
    </section>

    
    <section id="results-section" class="py-16 px-6 results-section hidden">
        <h2 class="text-3xl font-bold text-center mb-8">Результаты анализа</h2>
        
        <div class="max-w-6xl mx-auto">
            {% if not is_authenticated %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8" role="alert">
                    <p class="font-bold">Требуется авторизация</p>
                    <p>Для просмотра результатов анализа необходимо <a href="/auth/login/yandex-oauth2/" class="underline">авторизоваться</a>.</p>
                </div>
            {% endif %}
            
            <div id="results-container" class="{% if not is_authenticated %}blur-sm pointer-events-none{% endif %}">
                <div class="text-center mb-12">
                    <h3 class="text-2xl font-bold mb-2">Прогнозируемая стоимость</h3>
                    <p id="predicted-price" class="text-4xl font-bold text-cyan-600">0 ₽</p>
                    <p id="price-description" class="text-gray-600 mt-2">На основе выбранных параметров и текущих рыночных условий</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h4 class="text-xl font-bold mb-4">Динамика цен на рынке недвижимости</h4>
                        <div id="price-dynamics-chart" class="h-80"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h4 class="text-xl font-bold mb-4">Сравнение различных параметров</h4>
                        <div id="comparison-chart" class="h-80"></div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-lg mb-12">
                    <h4 class="text-xl font-bold mb-4">Факторы, влияющие на прогноз</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <ul class="space-y-4">
                                <li class="flex justify-between items-center">
                                    <span>Привлекательность района/локации (УРЖ)</span>
                                    <span id="factor-location" class="font-bold">30%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>Транспортная доступность</span>
                                    <span id="factor-transport" class="font-bold">20%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>Социальная инфраструктура района</span>
                                    <span id="factor-social" class="font-bold">15%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>Перспективы развития локации</span>
                                    <span id="factor-development" class="font-bold">20%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>Макроэкономические факторы</span>
                                    <span id="factor-macro" class="font-bold">15%</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div id="factors-chart" class="h-64"></div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="export-pdf-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 mr-4">
                        Экспортировать в PDF
                    </button>
                    <button id="export-excel-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Экспортировать в Excel
                    </button>
                </div>
            </div>
        </div>
    </section>

    
    <section class="py-16 px-6 bg-gray-50">
        <h2 class="text-3xl font-bold text-center mb-8">Инвестиционные сценарии доходности</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <div id="scenario-positive" class="scenario-card bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-green-600">Позитивный</h3>
                <p class="mb-6 text-sm">Оптимистичный прогноз с учетом благоприятных экономических факторов и максимального роста стоимости недвижимости.</p>
                <div id="positive-chart" class="h-48 mb-6"></div>
                <p class="text-center font-bold text-lg text-green-600">Ожидаемая доходность: <span id="positive-yield">10.5% в год</span></p>
            </div>
            
            <div id="scenario-realistic" class="scenario-card bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Реалистичный</h3>
                <p class="mb-6 text-sm">Сбалансированный прогноз с учетом наиболее вероятных изменений на рынке недвижимости и в экономике.</p>
                <div id="realistic-chart" class="h-48 mb-6"></div>
                <p class="text-center font-bold text-lg text-blue-600">Ожидаемая доходность: <span id="realistic-yield">7.0% в год</span></p>
            </div>
            
            <div id="scenario-conservative" class="scenario-card bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-600">Консервативный</h3>
                <p class="mb-6 text-sm">Осторожный прогноз, учитывающий возможные риски и минимальный рост стоимости недвижимости.</p>
                <div id="conservative-chart" class="h-48 mb-6"></div>
                <p class="text-center font-bold text-lg text-gray-600">Ожидаемая доходность: <span id="conservative-yield">3.5% в год</span></p>
            </div>
        </div>
        
        <div class="text-center mt-8">
            <button id="detailed-scenarios-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Перейти на страницу
            </button>
        </div>
    </section>

    
    <section class="py-16 px-6">
        <h2 class="text-3xl font-bold text-center mb-4">Настройка параметров</h2>
        <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">Создайте индивидуальный прогноз с учетом ваших сценариев, настроив параметры под ваши цели</p>
        
        <div class="max-w-6xl mx-auto">
            
            <div class="flex border-b mb-6">
                <button class="py-2 px-4 mr-4 active-tab" data-tab="economic">Экономические параметры</button>
                <button class="py-2 px-4 mr-4 text-gray-500 hover:text-gray-700" data-tab="location">Объект и локация</button>
                <button class="py-2 px-4 mr-4 text-gray-500 hover:text-gray-700" data-tab="strategy">Стратегия использования</button>
                <button class="py-2 px-4 text-gray-500 hover:text-gray-700" data-tab="financial">Финансовые параметры</button>
            </div>
            
            
            <div id="tab-economic" class="tab-content">
                <h3 class="text-xl font-bold mb-6">Макроэкономические параметры</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Инфляция, % годовых</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="inflation_rate" name="inflation_rate" min="2" max="15" value="4" class="w-full">
                            <span id="inflation_rate-value" class="text-sm font-medium">4%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ставка ЦБ, %</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="central_bank_rate" name="central_bank_rate" min="4" max="20" value="7" class="w-full">
                            <span id="central_bank_rate-value" class="text-sm font-medium">7%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Индекс потребительских цен, %</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="consumer_price_index" name="consumer_price_index" min="1" max="20" value="4" class="w-full">
                            <span id="consumer_price_index-value" class="text-sm font-medium">4%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Темп роста ВВП, %</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="gdp_growth_rate" name="gdp_growth_rate" min="-5" max="8" value="2" class="w-full">
                            <span id="gdp_growth_rate-value" class="text-sm font-medium">2%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Средняя ставка по ипотеке, %</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="mortgage_rate" name="mortgage_rate" min="3" max="15" value="8" class="w-full">
                            <span id="mortgage_rate-value" class="text-sm font-medium">8%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Средняя доходность депозитов, %</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <input type="range" id="deposit_rate" name="deposit_rate" min="1" max="12" value="5" class="w-full">
                            <span id="deposit_rate-value" class="text-sm font-medium">5%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tab-location" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-6">Параметры объекта и локации</h3>
                
                
                <p class="text-gray-600">Содержимое вкладки в разработке</p>
            </div>
            
            <div id="tab-strategy" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-6">Стратегии использования недвижимости</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="strategy-card p-4 rounded-lg" data-strategy="resale">
                        <h4 class="text-lg font-bold mb-2">Перепродажа</h4>
                        <p class="text-sm text-gray-600">Покупка с целью продажи через определенный срок по более высокой цене</p>
                    </div>
                    
                    <div class="strategy-card p-4 rounded-lg" data-strategy="long_rent">
                        <h4 class="text-lg font-bold mb-2">Долгосрочная аренда</h4>
                        <p class="text-sm text-gray-600">Сдача объекта в долгосрочную аренду для получения стабильного дохода</p>
                    </div>
                    
                    <div class="strategy-card p-4 rounded-lg" data-strategy="short_rent">
                        <h4 class="text-lg font-bold mb-2">Краткосрочная аренда</h4>
                        <p class="text-sm text-gray-600">Сдача объекта посуточно для получения максимального дохода</p>
                    </div>
                    
                    <div class="strategy-card p-4 rounded-lg" data-strategy="combined">
                        <h4 class="text-lg font-bold mb-2">Комбинированная</h4>
                        <p class="text-sm text-gray-600">Сдача в аренду с последующей перепродажей через определенный срок</p>
                    </div>
                </div>
            </div>
            
            <div id="tab-financial" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-6">Финансовые параметры</h3>
                
                
                <p class="text-gray-600">Содержимое вкладки в разработке</p>
            </div>
            
            <div class="text-center mt-8">
                <button id="build-scenario-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                    Построить новый сценарий
                </button>
            </div>
        </div>
    </section>

    <script>
        // Инициализация Яндекс Карты
        ymaps.ready(initMap);
        
        function initMap() {
            var myMap = new ymaps.Map('map', {
                center: [55.76, 37.64], // Москва
                zoom: 10,
                controls: ['zoomControl', 'searchControl']
            });
            
            // Обработчик клика по карте
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');
                
                // Очищаем карту от предыдущих меток
                myMap.geoObjects.removeAll();
                
                // Создаем метку
                var placemark = new ymaps.Placemark(coords, {}, {
                    preset: 'islands#redDotIcon'
                });
                
                myMap.geoObjects.add(placemark);
                
                // Получаем адрес по координатам
                ymaps.geocode(coords).then(function (res) {
                    var firstGeoObject = res.geoObjects.get(0);
                    var address = firstGeoObject.getAddressLine();
                    
                    // Сохраняем координаты и адрес
                    document.getElementById('location_lat').value = coords[0];
                    document.getElementById('location_lng').value = coords[1];
                    document.getElementById('location_address').value = address;
                    
                    // Отображаем выбранный адрес
                    alert('Выбран адрес: ' + address);
                });
            });
        }
        
        // Обработчики для ползунков
        const rangeInputs = document.querySelectorAll('input[type="range"]');
        rangeInputs.forEach(input => {
            const valueDisplay = document.getElementById(`${input.id}-value`);
            
            // Начальное значение
            if (valueDisplay) {
                let suffix = '';
                if (input.id === 'area') suffix = ' м²';
                else if (['inflation_rate', 'central_bank_rate', 'consumer_price_index', 'gdp_growth_rate', 'mortgage_rate', 'deposit_rate'].includes(input.id)) suffix = '%';
                
                valueDisplay.textContent = input.value + suffix;
            }
            
            // Обновление при изменении
            input.addEventListener('input', function() {
                if (valueDisplay) {
                    let suffix = '';
                    if (input.id === 'area') suffix = ' м²';
                    else if (['inflation_rate', 'central_bank_rate', 'consumer_price_index', 'gdp_growth_rate', 'mortgage_rate', 'deposit_rate'].includes(input.id)) suffix = '%';
                    
                    valueDisplay.textContent = input.value + suffix;
                }
            });
        });
        
        // Обработчик отправки формы прогноза
        document.getElementById('prediction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const locationLat = document.getElementById('location_lat').value;
            const locationLng = document.getElementById('location_lng').value;
            const locationAddress = document.getElementById('location_address').value;
            
            if (!locationLat || !locationLng || !locationAddress) {
                alert('Пожалуйста, выберите локацию на карте');
                return;
            }
            
            // Собираем данные формы
            const formData = new FormData();
            formData.append('location_lat', locationLat);
            formData.append('location_lng', locationLng);
            formData.append('location_address', locationAddress);
            formData.append('area', document.getElementById('area').value);
            formData.append('property_type', document.getElementById('property_type').value);
            formData.append('build_year', document.getElementById('build_year').value);
            formData.append('finishing_type', document.getElementById('finishing_type').value);
            formData.append('floor', document.getElementById('floor').value);
            
            // Отправляем запрос на сервер
            fetch('/calculate-prediction/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Сохраняем ID прогноза для экспорта
                    document.querySelector('body').dataset.predictionId = data.prediction_id;
                    
                    // Отображаем результаты
                    displayResults(data.results);
                    
                    // Прокручиваем к результатам
                    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при выполнении запроса');
            });
        });
        
        // Функция для отображения результатов
        function displayResults(results) {
            // Показываем секцию с результатами
            document.getElementById('results-section').classList.remove('hidden');
            
            // Получаем реалистичный сценарий для основных результатов
            const realisticScenario = results.realistic;
            
            // Обновляем прогнозируемую стоимость
            document.getElementById('predicted-price').textContent = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(realisticScenario.predicted_price);
            
            // Обновляем факторы влияния
            document.getElementById('factor-location').textContent = realisticScenario.influence_factors.location_attractiveness + '%';
            document.getElementById('factor-transport').textContent = realisticScenario.influence_factors.transport_accessibility + '%';
            document.getElementById('factor-social').textContent = realisticScenario.influence_factors.social_infrastructure + '%';
            document.getElementById('factor-development').textContent = realisticScenario.influence_factors.location_development + '%';
            document.getElementById('factor-macro').textContent = realisticScenario.influence_factors.macroeconomic + '%';
            
            // Создаем график динамики цен
            const priceDynamicsData = realisticScenario.price_dynamics;
            Plotly.newPlot('price-dynamics-chart', [{
                x: priceDynamicsData.dates,
                y: priceDynamicsData.prices,
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: '#1E88E5' },
                name: 'Прогноз стоимости'
            }], {
                margin: { t: 20, r: 20, b: 40, l: 60 },
                xaxis: { title: 'Дата' },
                yaxis: { title: 'Стоимость, руб.' }
            });
            
            // Создаем график сравнения инвестиций
            const comparisonData = realisticScenario.comparison_data;
            Plotly.newPlot('comparison-chart', [
                {
                    x: comparisonData.years,
                    y: comparisonData.property,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: '#1E88E5' },
                    name: 'Недвижимость'
                },
                {
                    x: comparisonData.years,
                    y: comparisonData.stocks,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: '#FFC107' },
                    name: 'Акции'
                },
                {
                    x: comparisonData.years,
                    y: comparisonData.bonds,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: '#4CAF50' },
                    name: 'Облигации'
                },
                {
                    x: comparisonData.years,
                    y: comparisonData.deposits,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: '#F44336' },
                    name: 'Депозиты'
                }
            ], {
                margin: { t: 20, r: 20, b: 40, l: 60 },
                xaxis: { title: 'Год' },
                yaxis: { title: 'Стоимость, руб.' }
            });
            
            // Создаем график факторов влияния
            Plotly.newPlot('factors-chart', [{
                values: [
                    realisticScenario.influence_factors.location_attractiveness,
                    realisticScenario.influence_factors.transport_accessibility,
                    realisticScenario.influence_factors.social_infrastructure,
                    realisticScenario.influence_factors.location_development,
                    realisticScenario.influence_factors.macroeconomic
                ],
                labels: [
                    'Привлекательность района',
                    'Транспортная доступность',
                    'Социальная инфраструктура',
                    'Перспективы развития',
                    'Макроэкономические факторы'
                ],
                type: 'pie',
                textinfo: 'percent',
                insidetextorientation: 'radial',
                marker: {
                    colors: ['#1E88E5', '#FFC107', '#4CAF50', '#F44336', '#9C27B0']
                }
            }], {
                margin: { t: 20, r: 20, b: 20, l: 20 }
            });
            
            // Обновляем инвестиционные сценарии
            updateInvestmentScenarios(results);
        }
        
        // Функция для обновления инвестиционных сценариев
        function updateInvestmentScenarios(results) {
            // Обновляем ожидаемую доходность
            document.getElementById('positive-yield').textContent = results.positive.annual_yield + '% в год';
            document.getElementById('realistic-yield').textContent = results.realistic.annual_yield + '% в год';
            document.getElementById('conservative-yield').textContent = results.conservative.annual_yield + '% в год';
            
            // Создаем графики для сценариев
            ['positive', 'realistic', 'conservative'].forEach(scenario => {
                const scenarioData = results[scenario].price_dynamics;
                const chartColors = {
                    positive: '#4CAF50',
                    realistic: '#1E88E5',
                    conservative: '#757575'
                };
                
                Plotly.newPlot(`${scenario}-chart`, [{
                    x: scenarioData.dates,
                    y: scenarioData.prices,
                    type: 'scatter',
                    mode: 'lines',
                    marker: { color: chartColors[scenario] },
                    fill: 'tozeroy',
                    fillcolor: `${chartColors[scenario]}20`
                }], {
                    margin: { t: 10, r: 10, b: 30, l: 50 },
                    xaxis: { showticklabels: false },
                    yaxis: { title: 'Стоимость, руб.' }
                });
            });
        }
        
        // Обработчики для вкладок
        const tabButtons = document.querySelectorAll('[data-tab]');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Удаляем активный класс у всех кнопок
                tabButtons.forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.classList.add('text-gray-500');
                    btn.classList.remove('text-gray-700');
                });
                
                // Добавляем активный класс текущей кнопке
                this.classList.add('active-tab');
                this.classList.remove('text-gray-500');
                
                // Скрываем все вкладки
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // Показываем выбранную вкладку
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
            });
        });
        
        // Обработчики для карточек стратегий
        const strategyCards = document.querySelectorAll('.strategy-card');
        strategyCards.forEach(card => {
            card.addEventListener('click', function() {
                // Удаляем выделение со всех карточек
                strategyCards.forEach(c => c.classList.remove('selected'));
                
                // Добавляем выделение текущей карточке
                this.classList.add('selected');
            });
        });
        
        // Обработчик для кнопки "Построить новый сценарий"
        document.getElementById('build-scenario-btn').addEventListener('click', function() {
            // Получаем выбранную стратегию
            const selectedStrategy = document.querySelector('.strategy-card.selected');
            if (!selectedStrategy) {
                alert('Пожалуйста, выберите стратегию использования недвижимости');
                return;
            }
            
            // Собираем данные из формы
            const macroParams = {
                inflation_rate: document.getElementById('inflation_rate').value,
                central_bank_rate: document.getElementById('central_bank_rate').value,
                consumer_price_index: document.getElementById('consumer_price_index').value,
                gdp_growth_rate: document.getElementById('gdp_growth_rate').value,
                mortgage_rate: document.getElementById('mortgage_rate').value,
                deposit_rate: document.getElementById('deposit_rate').value,
                investment_strategy: selectedStrategy.dataset.strategy
            };
            
            // Здесь будет логика для отправки запроса на сервер и обновления сценариев
            alert('Функция построения нового сценария находится в разработке');
        });
        
        // Обработчики для кнопок экспорта
        document.getElementById('export-pdf-btn').addEventListener('click', function() {
            const predictionId = document.querySelector('body').dataset.predictionId;
            if (!predictionId) {
                alert('Сначала необходимо выполнить расчет прогноза');
                return;
            }
            
            window.location.href = `/export-results/${predictionId}/pdf/`;
        });
        
        document.getElementById('export-excel-btn').addEventListener('click', function() {
            const predictionId = document.querySelector('body').dataset.predictionId;
            if (!predictionId) {
                alert('Сначала необходимо выполнить расчет прогноза');
                return;
            }
            
            window.location.href = `/export-results/${predictionId}/excel/`;
        });
        
        // Вспомогательная функция для получения CSRF-токена из cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
